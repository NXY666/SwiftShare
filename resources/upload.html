<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta content="width=device-width, initial-scale=1.0" name="viewport">
	<title>文件分片上传示例</title>
</head>
<body>
	<h2>文件分片上传</h2>
	<input id="file-input" type="file"/>
	<script>
		// // 分片大小，例如1MB
		// const CHUNK_SIZE = 1024 * 1024;
		//
		// // 将文件分割成分片
		// function sliceFile(file) {
		// 	let chunks = [];
		// 	for (let start = 0; start < file.size; start += CHUNK_SIZE) {
		// 		const chunk = file.slice(start, start + CHUNK_SIZE);
		// 		console.log(chunk);
		// 		chunks.push(chunk);
		// 	}
		// 	return chunks;
		// }
		//
		// // 上传单个分片
		// async function uploadChunk(chunk, index) {
		// 	const formData = new FormData();
		// 	formData.append("file", chunk);
		// 	formData.append("index", index);
		//
		// 	// 使用 fetch API 上传分片
		// 	await fetch('http://localhost:1234/', { // 替换成你的上传URL
		// 		method: 'POST',
		// 		body: formData
		// 	});
		// }
		//
		// // 主函数，处理文件分片上传
		// async function uploadFile(file) {
		// 	const chunks = sliceFile(file);
		// 	for (let i = 0; i < chunks.length; i++) {
		// 		await uploadChunk(chunks[i], i); // 顺序上传
		// 		// 或者使用 Promise.all(chunks.map((chunk, i) => uploadChunk(chunk, i))) 进行并行上传
		// 	}
		// 	// 可以发送一个请求来通知服务器所有分片已上传完成
		// }
		//
		// // 示例：获取 input 元素中的文件
		// document.getElementById('file-input').addEventListener('change', (event) => {
		// 	const file = event.target.files[0];
		// 	uploadFile(file);
		// });

		// // 创建WebSocket连接，并在连接建立时发送type参数
		// const typeParameter = 'your_parameter'; // 替换为您希望传递的参数
		// const socket = new WebSocket('ws://localhost:3000/test?type=' + typeParameter);
		//
		// // 监听WebSocket连接事件
		// socket.addEventListener('open', (event) => {
		// 	console.log('WebSocket connection established.');
		// });
		//
		// // 监听WebSocket接收消息事件
		// socket.addEventListener('message', (event) => {
		// 	console.log('Received message from server:', event.data);
		// });
		//
		// // 监听WebSocket关闭事件
		// socket.addEventListener('close', (event) => {
		// 	console.log('WebSocket connection closed:', event);
		// });

		const api = {
			/**
			 * 发送 GET 请求
			 * @param {string} url 请求地址
			 * @param {RequestInit} [options] 请求选项
			 * @param {boolean} [slowRequest] 是否为慢速请求
			 * @param {number} [retryCount] 重试次数
			 * @return {Promise<string|array|object>} 响应数据
			 */
			get: (url, options = {}, {slowRequest = false, retryCount = 3} = {slowRequest: false, retryCount: 3}) => {
				return fetch(new URL(url, host).href, {
					...options,
					method: 'GET'
				})
				.then(async response => ({ok: response.ok, code: response.status, body: await response.text()}))
				.then(response => {
					if (response.ok) {
						try {
							return {code: response.code, data: JSON.parse(response.body)};
						} catch {
							return {code: response.code, data: response.body};
						}
					} else {
						throw {code: response.code, message: response.body || response.code};
					}
				})
				.catch(error => {
					if (error instanceof Error) {
						console.error(error);
						if (retryCount > 0) {
							return api.get(url, options, {slowRequest, retryCount: retryCount - 1});
						} else {
							throw {code: -1, message: error.toString()};
						}
					} else {
						throw error;
					}
				});
			},
			/**
			 * 发送 POST 请求
			 * @param {string} url 请求地址
			 * @param {string|object} body 请求体
			 * @param {object} [options] fetch 选项
			 * @param {{slowRequest: boolean, retryCount: number}} [config] 请求配置
			 * @return {Promise<string|array|object>} 响应数据
			 */
			post: (url, body, options = {}, config = {}) => {
				if (!options.headers) {
					options.headers = {};
				}
				if (body instanceof FormData) {
					// do nothing
				} else if (typeof body == 'object') {
					try {
						body = JSON.stringify(body);
						options.headers['Content-Type'] = 'application/json';
					} catch (e) {
						console.error(e);
					}
				} else if (typeof body == 'string') {
					options.headers['Content-Type'] = 'text/plain';
				} else {
					throw new Error('Unsupported body type.');
				}

				return fetch(new URL(url, host).href, {
					...options,
					method: 'POST',
					body
				})
				.then(async response => ({ok: response.ok, code: response.status, body: await response.text()}))
				.then(response => {
					if (response.ok) {
						try {
							return {code: response.code, data: JSON.parse(response.body)};
						} catch {
							return {code: response.code, data: response.body};
						}
					} else {
						throw {code: response.code, message: response.body || response.code};
					}
				})
				.catch(error => {
					if (error instanceof Error) {
						console.error(error);
						if (config.retryCount > 0) {
							return api.post(url, body, options, {slowRequest: config.slowRequest, retryCount: config.retryCount - 1});
						} else {
							throw {code: -1, message: error.toString()};
						}
					} else {
						throw error;
					}
				});
			}
		};

		const host = "http://localhost:3000/";
		// fetch post /upload/files/apply {test: 1}
		// api.post('/upload/files/apply', {
		// 	files: [
		// 		{
		// 			name: 'test1.txt',
		// 			size: 1024
		// 		},
		// 		{
		// 			name: 'test2.txt',
		// 			size: 1024
		// 		}
		// 	],
		// 	allowMultipart: true
		// });
		function a({a = 1, b = 2} = {a: 1, b: 2}) {
			console.log(a, b);
		}
		a();
	</script>
</body>
</html>
